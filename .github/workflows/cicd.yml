name: Selenium Test Automation CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *' # Nightly at 2 AM

env:
  JAVA_VERSION: '21'
  MAVEN_OPTS: -Xmx1024m

jobs:
  # Job 1: Compile the project
  compile:
    name: Compile Project
    runs-on: windows-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: temurin
          cache: maven

      - name: Cache Maven Dependencies
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Compile with Maven
        run: mvn clean compile

  # Job 2: Security Scanning
  security-check:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: compile

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Run Trivy Vulnerability Scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: fs
          scan-ref: '.'
          format: sarif
          output: trivy-results.sarif

      - name: Upload Trivy Results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: trivy-results.sarif

      - name: Run Gitleaks Secret Scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Job 3: SonarQube Code Quality
  sonarqube-analysis:
    name: SonarQube Code Quality
    runs-on: ubuntu-latest
    needs: security-check
    if: github.event_name == 'push' || github.event_name == 'pull_request'

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: temurin
          cache: maven

      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v5.0.0
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ vars.SONAR_HOST_URL }}

      - name: SonarQube Quality Gate Check
        uses: sonarsource/sonarqube-quality-gate-action@master
        timeout-minutes: 5
        with:
          pollingTimeoutSec: 300
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ vars.SONAR_HOST_URL }}

  # Job 4: Smoke Tests
  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    needs: compile

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: temurin
          cache: maven

      - name: Setup Chrome Browser
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable

      - name: Setup ChromeDriver
        uses: nanasess/setup-chromedriver@v2

      - name: Verify Chrome Installation
        run: |
          google-chrome --version || true
          chromedriver --version || true

      - name: Run Smoke Tests
        run: mvn test -DsuiteXmlFile=testng-smoke.xml
        continue-on-error: true

      - name: Upload Smoke Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-results
          path: |
            target/surefire-reports/
            target/site/
          retention-days: 7

  # Job 5: Regression Tests
  regression-tests:
    name: Regression Tests
    runs-on: ubuntu-latest
    needs: smoke-tests
    if: github.event_name == 'push' || github.event_name == 'schedule'

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: temurin
          cache: maven

      - name: Setup Chrome Browser
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable

      - name: Setup ChromeDriver
        uses: nanasess/setup-chromedriver@v2

      - name: Run Regression Tests
        run: mvn test -DsuiteXmlFile=testng-regression.xml
        continue-on-error: true

      - name: Generate Test Report
        if: always()
        run: mvn surefire-report:report-only

      - name: Upload Regression Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: regression-test-results
          path: |
            target/surefire-reports/
            target/site/
          retention-days: 30

      - name: Upload Screenshots on Failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-failure-screenshots
          path: screenshots/
          retention-days: 7

      - name: Publish Test Report
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: Regression Test Results
          path: target/surefire-reports/*.xml
          reporter: java-junit
          fail-on-error: false

  # Job 6: Build and Package
  build-package:
    name: Build and Package
    runs-on: ubuntu-latest
    needs:
      - smoke-tests
      - sonarqube-analysis
    if: needs.smoke-tests.result == 'success'

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: temurin
          cache: maven

      - name: Build Project
        run: mvn clean package -DskipTests

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: test-automation-package
          path: target/*.jar
          retention-days: 30

  # Job 7: Test Results Summary and Notifications
  test-summary:
    name: Test Results Summary
    runs-on: ubuntu-latest
    needs:
      - smoke-tests
      - regression-tests
    if: always()

    steps:
      - name: Download Smoke Test Results
        if: needs.smoke-tests.result != 'skipped'
        uses: actions/download-artifact@v4
        with:
          name: smoke-test-results
          path: smoke-results

      - name: Download Regression Test Results
        if: needs.regression-tests.result != 'skipped'
        uses: actions/download-artifact@v4
        with:
          name: regression-test-results
          path: regression-results
        continue-on-error: true

      - name: Generate Test Summary
        run: |
          echo "## üß™ Test Automation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Smoke Tests: ${{ needs.smoke-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "### Regression Tests: ${{ needs.regression-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[View Full Report](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY

      - name: Comment PR with Test Results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const smokeResult = '${{ needs.smoke-tests.result }}';
            const regressionResult = '${{ needs.regression-tests.result }}';

            const icon = smokeResult === 'success' ? '‚úÖ' : '‚ùå';

            const comment = `## ${icon} Test Automation Results

            | Test Suite | Status |
            |------------|--------|
            | Smoke Tests | ${smokeResult} |
            | Regression Tests | ${regressionResult} |

            **Details:** [View Full Report](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # Job 8: Send Email Notifications (Optional)
  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs:
      - smoke-tests
      - regression-tests
    if: always()

    steps:
      - name: Send Failure Notification
        run: |
          echo "‚ùå Tests Failed!"
          echo "Smoke Tests: ${{ needs.smoke-tests.result }}"
          echo "Regression Tests: ${{ needs.regression-tests.result }}"
          echo "Please check the Actions tab for details"
