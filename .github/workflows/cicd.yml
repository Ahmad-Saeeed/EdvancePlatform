name: EdvancePlatform - CI Pipeline

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
    paths:
      - '**.java'
      - 'pom.xml'
      - 'testng.xml'
      - '.github/workflows/**'
  
  pull_request:
    branches:
      - main
      - develop
    types: [opened, synchronize, reopened]
  
  schedule:
    # Daily regression at 2 AM UTC
    - cron: '0 2 * * *'
  
  workflow_dispatch:
    inputs:
      browser:
        description: 'Browser'
        required: true
        default: 'chrome'
        type: choice
        options:
          - chrome
          - firefox
          - edge
      suite:
        description: 'Test Suite'
        required: true
        default: 'regression'
        type: choice
        options:
          - smoke
          - regression
          - sanity
          - full

env:
  JAVA_VERSION: '11'
  MAVEN_OPTS: -Xmx1024m

jobs:
  # ==========================================
  # Job 1: Build & Compile
  # ==========================================
  build:
    name: Build Project
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ‚òï Setup Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'
      
      - name: üîç Display Maven Version
        run: mvn -version
      
      - name: üî® Compile Project
        run: |
          cd EdvancePlatform
          mvn clean compile -DskipTests
      
      - name: üì¶ Package Project
        run: |
          cd EdvancePlatform
          mvn package -DskipTests
      
      - name: ‚úÖ Build Complete
        run: echo "Build completed successfully!"

  # ==========================================
  # Job 2: Smoke Tests (Fast Feedback)
  # ==========================================
  smoke-tests:
    name: Smoke Tests - ${{ matrix.browser }}
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'push'
    
    strategy:
      fail-fast: false
      matrix:
        browser: [chrome]
    
    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4
      
      - name: ‚òï Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'
      
      - name: üåê Setup Chrome
        uses: browser-actions/setup-chrome@latest
      
      - name: üß™ Run Smoke Tests
        id: smoke-test
        continue-on-error: true
        run: |
          cd EdvancePlatform
          mvn test \
            -Dbrowser=${{ matrix.browser }} \
            -Dheadless=true \
            -Dgroups=smoke \
            -DsuiteXmlFile=testng-smoke.xml
      
      - name: üìä Generate Report
        if: always()
        run: |
          cd EdvancePlatform
          mvn surefire-report:report-only
      
      - name: üì§ Upload Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-results-${{ matrix.browser }}
          path: |
            EdvancePlatform/target/surefire-reports/
            EdvancePlatform/target/site/
          retention-days: 7
      
      - name: üì∏ Upload Screenshots (If Failed)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-screenshots-${{ matrix.browser }}
          path: EdvancePlatform/test-output/screenshots/
          retention-days: 7
      
      - name: ‚ùå Fail if tests failed
        if: steps.smoke-test.outcome == 'failure'
        run: exit 1

  # ==========================================
  # Job 3: Full Test Suite
  # ==========================================
  regression-tests:
    name: Regression - ${{ matrix.browser }}
    needs: build
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'schedule' || 
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'push' && github.ref == 'refs/heads/main')
    
    strategy:
      fail-fast: false
      matrix:
        browser: [chrome, firefox]
    
    steps:
      - name: üì• Checkout Code
        uses: actions/checkout@v4
      
      - name: ‚òï Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'
      
      - name: üåê Setup Chrome
        if: matrix.browser == 'chrome'
        uses: browser-actions/setup-chrome@latest
      
      - name: ü¶ä Setup Firefox
        if: matrix.browser == 'firefox'
        uses: browser-actions/setup-firefox@latest
      
      - name: üß™ Run Regression Tests
        id: regression-test
        continue-on-error: true
        timeout-minutes: 90
        run: |
          cd EdvancePlatform
          mvn test \
            -Dbrowser=${{ matrix.browser }} \
            -Dheadless=true \
            -DsuiteXmlFile=testng-regression.xml \
            -Dthreads=3
      
      - name: üìä Generate Reports
        if: always()
        run: |
          cd EdvancePlatform
          mvn surefire-report:report-only
      
      - name: üì§ Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: regression-results-${{ matrix.browser }}-${{ github.run_number }}
          path: |
            EdvancePlatform/target/surefire-reports/
            EdvancePlatform/target/site/
            EdvancePlatform/test-output/
          retention-days: 30
      
      - name: üì∏ Upload Screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: regression-screenshots-${{ matrix.browser }}-${{ github.run_number }}
          path: EdvancePlatform/test-output/screenshots/
          retention-days: 30
      
      - name: üìã Publish Test Results
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: Regression Tests - ${{ matrix.browser }}
          path: EdvancePlatform/target/surefire-reports/*.xml
          reporter: java-junit
          fail-on-error: false
      
      - name: ‚ùå Fail if tests failed
        if: steps.regression-test.outcome == 'failure'
        run: exit 1

  # ==========================================
  # Job 4: Test Summary & Notification
  # ==========================================
  test-summary:
    name: Test Summary
    needs: [smoke-tests, regression-tests]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: üìä Generate Summary
        run: |
          echo "# üß™ EdvancePlatform Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow:** ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Actor:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.smoke-tests.result }}" == "success" ]]; then
            echo "‚úÖ **Smoke Tests:** PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Smoke Tests:** FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ needs.regression-tests.result }}" == "success" ]]; then
            echo "‚úÖ **Regression Tests:** PASSED" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.regression-tests.result }}" == "skipped" ]]; then
            echo "‚è≠Ô∏è **Regression Tests:** SKIPPED" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Regression Tests:** FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üìä [View Detailed Results](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
      
      - name: üí¨ Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const smokeResult = '${{ needs.smoke-tests.result }}';
            const emoji = smokeResult === 'success' ? '‚úÖ' : '‚ùå';
            
            const comment = `
            ## ${emoji} Automated Test Results
            
            **Smoke Tests:** ${smokeResult === 'success' ? '‚úÖ PASSED' : '‚ùå FAILED'}
            
            ${smokeResult === 'success' 
              ? '‚úÖ All smoke tests passed! Your PR is ready for review.' 
              : '‚ùå Some tests failed. Please fix the issues before merging.'}
            
            **Details:**
            - Workflow: ${context.workflow}
            - Run ID: ${context.runId}
            - Commit: \`${context.sha.substring(0, 7)}\`
            
            [üìä View Full Results](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # ==========================================
  # Job 5: Slack Notification
  # ==========================================
  notify:
    name: Send Notifications
    needs: [smoke-tests, regression-tests]
    runs-on: ubuntu-latest
    if: always() && (github.event_name == 'schedule' || github.event_name == 'push')
    
    steps:
      - name: üìß Send Slack Notification
        if: ${{ secrets.SLACK_WEBHOOK_URL != '' }}
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "EdvancePlatform Test Results",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "${{ needs.smoke-tests.result == 'success' && needs.regression-tests.result == 'success' && '‚úÖ' || '‚ùå' }} EdvancePlatform - Test Results"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Workflow:*\n${{ github.workflow }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Branch:*\n${{ github.ref_name }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Smoke Tests:*\n${{ needs.smoke-tests.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Regression:*\n${{ needs.regression-tests.result == 'success' && '‚úÖ Passed' || needs.regression-tests.result == 'skipped' && '‚è≠Ô∏è Skipped' || '‚ùå Failed' }}"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Results"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
